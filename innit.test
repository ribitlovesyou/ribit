Python 3.13.2 (v3.13.2:4f8bb3947cf, Feb  4 2025, 11:51:10) [Clang 15.0.0 (clang-1500.3.9.4)] on darwin
Type "help", "copyright", "credits" or "license()" for more information.

"""Tests for the Ribit Digital Being framework."""

import asyncio
import pytest
import sys
from pathlib import Path

# Add source to path
sys.path.insert(0, str(Path(__file__).parent.parent / "my_digital_being"))


class TestBeingState:
    """Test the BeingState class."""

    def test_initial_state(self):
        from framework.state import BeingState

        state = BeingState()
        assert state.energy == 100.0
        assert state.mood == 75.0
        assert state.total_activities_run == 0

    def test_energy_bounds(self):
        from framework.state import BeingState

        state = BeingState()
        state.update_energy(-200)
        assert state.energy == 0.0

        state.update_energy(500)
        assert state.energy == 100.0

    def test_mood_bounds(self):
        from framework.state import BeingState

        state = BeingState()
        state.update_mood(-200)
        assert state.mood == 0.0

        state.update_mood(500)
        assert state.mood == 100.0

    def test_record_activity(self):
        from framework.state import BeingState

        state = BeingState()
        state.record_activity("test_activity")
        assert state.last_activity_name == "test_activity"
        assert state.total_activities_run == 1

    def test_to_dict(self):
        from framework.state import BeingState

        state = BeingState()
        d = state.to_dict()
        assert "energy" in d
        assert "mood" in d
        assert "creativity" in d


class TestSharedData:
    """Test the SharedData class."""

    def test_set_get(self):
        from framework.shared_data import SharedData

        sd = SharedData()
        sd.set("key1", "value1")
        assert sd.get("key1") == "value1"

    def test_get_default(self):
        from framework.shared_data import SharedData

        sd = SharedData()
        assert sd.get("nonexistent", "default") == "default"

    def test_delete(self):
        from framework.shared_data import SharedData

        sd = SharedData()
        sd.set("key1", "value1")
        sd.delete("key1")
        assert not sd.has("key1")

    def test_keys(self):
        from framework.shared_data import SharedData

        sd = SharedData()
        sd.set("a", 1)
        sd.set("b", 2)
        assert set(sd.keys()) == {"a", "b"}


class TestActivityDecorator:
    """Test the activity decorator system."""

    def test_decorator_registration(self):
        from framework.activity_decorator import (
            ActivityBase,
            ActivityResult,
            activity,
            get_activity_registry,
        )

        @activity(name="test_activity", energy_cost=0.5, cooldown=60)
        class TestActivity(ActivityBase):
            async def execute(self, shared_data):
                return ActivityResult(success=True)

        registry = get_activity_registry()
        assert "test_activity" in registry
        assert registry["test_activity"]["energy_cost"] == 0.5

    def test_activity_result(self):
        from framework.activity_decorator import ActivityResult

        result = ActivityResult(success=True, data={"key": "value"})
        assert result.success is True
        assert result.data["key"] == "value"
        assert result.error is None


class TestMemoryManager:
    """Test the MemoryManager class."""

    def test_short_term_memory(self):
        from framework.memory import MemoryManager

        mm = MemoryManager()
        loop = asyncio.new_event_loop()
        loop.run_until_complete(mm.store("test", "Hello Ribit!"))
        recent = mm.get_recent_short_term(1)
        assert len(recent) == 1
        assert recent[0]["content"] == "Hello Ribit!"
        loop.close()

    def test_short_term_limit(self):
        from framework.memory import MemoryManager

        mm = MemoryManager()
        mm.max_short_term = 5
        loop = asyncio.new_event_loop()
        for i in range(10):
            loop.run_until_complete(mm.store("test", f"Memory {i}"))
        assert len(mm.short_term) == 5
        loop.close()


class TestAPIManager:
    """Test the APIManager class."""

    def test_register_keys(self):
        from framework.api_management import APIManager

        mgr = APIManager()
        mgr.register_required_keys("test_skill", ["KEY_A", "KEY_B"])
        skills = mgr.get_all_registered_skills()
        assert "test_skill" in skills
        assert "KEY_A" in skills["test_skill"]

    def test_check_skill_keys(self):
        from framework.api_management import APIManager

        mgr = APIManager()
        mgr.register_required_keys("test_skill", ["NONEXISTENT_KEY_12345"])
        status = mgr.check_skill_keys("test_skill")
        assert status["NONEXISTENT_KEY_12345"] is False
